workspace:
  base: /go

image-ebayn: &image-alpha
  image: gcr.io/npd-shared/cd:2.0-latest

pipeline:

  test:
    image: golang
    commands:
      - go get github.com/cloudflare/cfssl/log
      - go get k8s.io/client-go/...
      - go get -u k8s.io/apimachinery/...
      - go test
      - GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build
    when:
      event: [push, pull_request, tag]

  publish:
    <<: *image-alpha
    run: publish
    privileged: true
    environment:
      - GOPATH=/golang
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    when:
      event: [push, pull_request, tag]
      branch: [master]

  n0_rollout_dev:
    <<: *image-alpha
    group: rollout_dev
    run: rollout
    env: dev
    team: shared
    initiative: n0
    when:
      event: [push, tag]
      branch: [master]

  n0_rollout_test:
    <<: *image-alpha
    group: rollout_test
    run: rollout
    env: test
    team: shared
    initiative: n0
    when:
      event: [push, tag]
      branch: [master]

  n0_rollout_prod:
    <<: *image-alpha
    group: rollout_prod
    run: rollout
    env: prod
    team: shared
    initiative: n0
    when:
      event: [deployment]
      environment: prod

  n1_rollout_dev:
    <<: *image-alpha
    group: rollout_dev
    run: rollout
    env: dev
    team: shared
    initiative: n1
    when:
      event: [push, tag]
      branch: [master]

  n1_rollout_test:
    <<: *image-alpha
    group: rollout_test
    run: rollout
    env: test
    team: shared
    initiative: n1
    when:
      event: [push, tag]
      branch: [master]

  n1_rollout_prod:
    <<: *image-alpha
    group: rollout_prod
    run: rollout
    env: prod
    team: shared
    initiative: n1
    when:
      event: [deployment]
      environment: prod

  n2_rollout_dev:
    <<: *image-alpha
    group: rollout_dev
    run: rollout
    env: dev
    team: shared
    initiative: n2
    when:
      event: [push, tag]
      branch: [master]

  n2_rollout_test:
    <<: *image-alpha
    group: rollout_test
    run: rollout
    env: test
    team: shared
    initiative: n2
    when:
      event: [push, tag]
      branch: [master]

  n2_rollout_prod:
    <<: *image-alpha
    group: rollout_prod
    run: rollout
    env: prod
    team: shared
    initiative: n2
    when:
      event: [deployment]
      environment: prod

  restricted_rollout_dev:
    <<: *image-alpha
    group: rollout_dev
    run: rollout
    env: dev
    team: shared
    initiative: restricted
    when:
      event: [push, tag]
      branch: [master]

  restricted_rollout_test:
    <<: *image-alpha
    group: rollout_test
    run: rollout
    env: test
    team: shared
    initiative: restricted
    when:
      event: [push, tag]
      branch: [master]

  restricted_rollout_prod:
    <<: *image-alpha
    group: rollout_prod
    run: rollout
    env: prod
    team: shared
    initiative: restricted
    when:
      event: [deployment]
      environment: prod
